<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>Frame&#39;s Blog</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="/css/main.min.2545a1910010e26a9905276045afab868f812580a1e7482423da6c0c8c214d18.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="/">Frame&#39;s Blog</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="/about/">关于</a>
  
    <a class="color-link nav-link" href="/tags/">标签</a>
  
    <a class="color-link nav-link" href="/archives/">归档</a>
  
</div>
<footer class="footer">
	<div class="social-icons">
        
    <a class="social-icon" href="mailto:saintube@foxmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://www.github.com/saintube" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://www.cncf.io/" target="_blank" rel="noopener">CNCF</a></p>
	<p><a href="https://landscape.cncf.io/" target="_blank" rel="noopener">Landscape</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">Device Plugin 入门笔记（一）</h1>
    
    <time>March 12, 2020</time>
    
    <div>
        <p>
        <p>本节介绍Kubernetes中的Device Plugin概念，整理了社区在此方向的架构设计，并简要归纳了Device Plugin的生命周期。</p>
<h2 id="background">Background</h2>
<p>Kubernetes能在集群上做容器的编排，限制容器、Pod对CPU、内存资源的使用，并根据worker nodes的可用资源情况，进行及时和精准的容器调度。自然而然地，诸如GPU、NIC等其异构资源也被考虑到容器编排调度的资源池中，以加速异构资源的容器部署，并扩展容器隔离性的范畴。</p>
<p>不过社区也考虑了这些硬件的多样性，很难说把各种管理不同硬件资源的代码都合入K8s项目中，所以就试图提供统一的插件化方案来让用户（主要是设备提供商）在K8s上自定义这些资源的管控。<br>
这个方案叫<code>Device Manager</code>，实际上是通过在K8s中内置<code>Extended Resource</code>和<code>Device Plugin</code>两个模块，来允许用户自己编写对应硬件资源的Device Plugin，最终串起硬件资源在集群级别的调度、以及在nodes上的实际绑定。为此，K8s社区也下足了决心，移除了nvidia-gpu在K8s项目主干的代码。</p>
<h2 id="overview">Overview</h2>
<h3 id="objective">Objective</h3>
<p>首先明确一下Device Plugin以及Device Manager的工作范畴：</p>
<ul>
<li>Device Plugin会利用Kubelet内置的扩展机制，来管控特定设备，包括设备的发现和health check，以及协助runtime利用和清理设备资源。</li>
<li>Device Manager方案负责为Device Plugin提供部署和版本控制的API。</li>
<li>Device Manager不负责异构节点及拓扑相关的问题。</li>
<li>Device Manager只解决硬件资源的health check，不负责收集metrics。</li>
<li>Device Plugin目前版本的资源分配未涉及QoS，默认为limits=requests。</li>
</ul>
<h3 id="tl-dr">TL; DR</h3>
<p><strong>Extended Resource</strong>:</p>
<p>这个模块提供了自定义资源的扩展，用户可以把资源的名称和数量上报给API Server。Scheduler调度pod时，会根据该类资源的数量条件进行判断。<br>
目前这类资源的delta必须为整数，未来可能允许浮点数。</p>
<p><strong>Device Plugin</strong>:</p>
<p>Device Plugins其实是一些以Pod中容器或者bare-metal-mode运行的简单的gRPC servers。</p>
<p><img src="https://uploadfiles.nowcoder.com/images/20200312/702387425_1584002729817_0E4450DFBF9B83E0F4F29F43E39EBCE9" alt="device-plugin-overview" title="Device Plugin Overview"></p>
<p>这些servers会实现Device Manager定义的gRPC interface，在Kubelet中注册，让Kubelet通过gRPC去调用Device Plugin的<code>ListAndWatch()</code>和<code>Allocate()</code>方法。</p>
<ul>
<li><code>ListAndWatch()</code>方法帮助Kubelet discover和watch设备资源的变化；</li>
<li><code>Allocate()</code>方法允许Kubelet在创建使用该设备资源的容器时，告诉Device Plugin进行设备绑定容器的具体操作，并告诉Device Plugin使用的device、volume以及env配置。</li>
</ul>
<h2 id="design">Design</h2>
<h3 id="api-design">API Design</h3>
<p>前面说了，Device Plugins实际上是一些gRPC servers。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">service</span> <span style="color:#a6e22e">DevicePlugin</span> {
	<span style="color:#75715e">// returns a stream of []Device
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">rpc</span> <span style="color:#a6e22e">ListAndWatch</span>(<span style="color:#a6e22e">Empty</span>) <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">stream</span> <span style="color:#a6e22e">ListAndWatchResponse</span>) {}
	<span style="color:#a6e22e">rpc</span> <span style="color:#a6e22e">Allocate</span>(<span style="color:#a6e22e">AllocateRequest</span>) <span style="color:#a6e22e">returns</span> (<span style="color:#a6e22e">AllocateResponse</span>) {}
}
</code></pre></div><p>更详细的API规范请参考<a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/resource-management/device-plugin.md#api-specification"><em>Device Plugin API Spec</em></a>。</p>
<h2 id="lifecycle">Lifecycle</h2>
<p>一开始，Device Plugin需要主动去提醒Kubelet的gRPC server，以告知它的存在。<br>
Kubelet和Device Plugin的gRPC server通过host上的Unix Socket进行通信，比如<code>/var/lib/kubelet/device-plugins/nvidiaGPU.sock</code>。</p>
<p>具体的Device Plugin生命周期如下图所示，分为注册、发现、分配、停止四个阶段。</p>
<p><img src="https://uploadfiles.nowcoder.com/images/20200312/702387425_1584004462174_66F4085E51398986C8F569C56B805427" alt="device-plugin-lifecycle" title="Device Plugin Lifecycle"></p>
<h3 id="registration">Registration</h3>
<ol>
<li>社区推荐的是以daemonset的方式去部署Device Plugin，i.e. <code>kubectl create -f nvidia.io/device-plugin.yml</code>。Daemonset的容器会在所有nodes上run起来，看当前node上是否有可用的设备资源，如果没有就terminate掉（假设restartPolicy是OnFailure）。</li>
<li>Device Plugin启动时，通过gRPC往<code>/var/lib/kubelet/device-plugins/kubelet.sock</code>（Kubelet gRPC server的socket）发<code>RegisterRequest</code>，在Kubelet中注册，并提供Device Plugin的Unix Socket、API version、device name（<code>ResourceName</code>）。Kubelet会回复<code>RegisterResponse</code>，包含了可能触发的error，比如API version不支持或者已有同名的Device Plugin注册过。如果Kubelet没有回复error，Device Plugin才会开始运行自己的gRPC server。</li>
<li>同时，Kubelet也会将设备资源信息暴露到Node status中，设备资源会以Extended Resources的形式（<code>vendor-domain/vendor-device</code>的格式，如<code>nivida.com/gpu</code>）在Apiserver上公布，后续Scheduler会利用该信息进行调度。</li>
</ol>
<h3 id="discovery">Discovery</h3>
<ol>
<li>Device Plugin启动后，Kubelet会和它建立一个ListAndWatch的长连接。Device Plugin向Kubelet公告一个devices list，如果设备情况发生变化则会重发。</li>
<li>当某个设备的health check失败，就会通知Kubelet。如果该设备空闲，Kubelet会将其挪出可分配列表；如果该设备被某个Pod使用，Kubelet会将该kill掉该Pod。</li>
<li>Device Plugin可以利用Kubelet的socket持续检查Kubelet的状态，在Kubelet重启时让插件也重启，向Kubelet重新注册。</li>
</ol>
<h3 id="allocation">Allocation</h3>
<ol>
<li>Scheduler从cache中选择资源满足的node；Node收到Add Pod，对Pod信息进行<code>admit()</code>方法来判断是否可运行。判断中就包括了<code>UpdatePluginResource()</code>这个handler。该方案会调用<code>devicePluginManager</code>的<code>Allocate()</code>方法，对Kubelet缓存中记录的资源可用量进行判断和计算，并选定要使用的设备。</li>
<li>确定创建容器时，Kubelet会调用Device Plugin的<code>Allocate()</code>函数。</li>
<li>Device Plugin被call后，根据request的device id，检查设备是否可用；可用的话会执行设备特定的命令，比如GPU cleanup、QRNG初始化等；并向Kubelet返回在容器创建时对设备的配置，包括<code>Env</code>、<code>Mounts</code>、<code>Devices</code>；该配置会被记录在<code>podDevices</code>这个map中。</li>
<li>Kubelet创建Pod的容器时，产生如下调用链，从<code>podDevices</code>在获取容器使用的设备，组织成容器运行时的参数<code>opts</code>，传递到container runtime中，最终run container时会用<code>opts</code>到。比如GPU容器，会在<code>opts</code>中增加<code>--devices</code>的参数指定，让容器挂上需要的设备。</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">GenerateRunContainerOptions</span>() <span style="color:#f92672">-</span>&gt; <span style="color:#a6e22e">containerManager</span>.<span style="color:#a6e22e">GetResources</span>()
<span style="color:#f92672">-</span>&gt; <span style="color:#a6e22e">devicePluginManager</span>.<span style="color:#a6e22e">GetDeviceRunContainerOptions</span>() <span style="color:#f92672">-</span>&gt; <span style="color:#a6e22e">deviceRunContainerOptions</span>()
</code></pre></div><h3 id="stop">Stop</h3>
<ol>
<li>这里的Stop指Device Plugin自身停止时想做的清理工作，比如清理Socket、unload driver之类的事情，即对应Device Plugin生命周期的Stop，而非Kubelet控制的Pod生命周期。</li>
<li>至于设备失效，Device Plugin会通过<code>ListAndWatch</code> gRPC stream来提示Kubelet，Kubelet会据此让Pod失效，比如Kill掉Pod。</li>
</ol>
<h2 id="references">References</h2>
<ol>
<li><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/device-plugins/#">Device Plugins - Kubernetes</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/resource-management/device-plugin.md">Device Manager Proposal - kubernetes/community</a></li>
<li><a href="https://developer.aliyun.com/article/498185">Kubernetes的Device Plugin设计解读 - 阿里云开发者社区</a></li>
<li><a href="https://yq.aliyun.com/articles/679900">k8s的扩展资源设计和device-plugin - 阿里云云栖社区</a></li>
</ol>

        </p>
    </div>
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "Frame" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="/tags/cloud">#cloud</a>
        
            <a class="tag" href="/tags/container">#container</a>
        
            <a class="tag" href="/tags/virtualization">#virtualization</a>
        
            <a class="tag" href="/tags/kubernetes">#kubernetes</a>
        
      
    </div>


        

<link rel="stylesheet" type="text/css" href="/css/katex.min.css">
<script type="text/javascript" src="/js/katex.min.js"></script>
<script type="text/javascript" src="/js/auto-render.min.js"onload="renderMathInElement(document.body);"></script>

        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        
    <a class="social-icon" href="mailto:saintube@foxmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://www.github.com/saintube" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://www.cncf.io/" target="_blank" rel="noopener">CNCF</a></p>
		<p><a href="https://landscape.cncf.io/" target="_blank" rel="noopener">Landscape</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>