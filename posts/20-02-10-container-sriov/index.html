<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>Frame&#39;s Blog</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="/css/main.min.2545a1910010e26a9905276045afab868f812580a1e7482423da6c0c8c214d18.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="/">Frame&#39;s Blog</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="/about/">关于</a>
  
    <a class="color-link nav-link" href="/tags/">标签</a>
  
    <a class="color-link nav-link" href="/archives/">归档</a>
  
</div>
<footer class="footer">
	<div class="social-icons">
        
    <a class="social-icon" href="mailto:saintube@foxmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://www.github.com/saintube" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://www.cncf.io/" target="_blank" rel="noopener">CNCF</a></p>
	<p><a href="https://landscape.cncf.io/" target="_blank" rel="noopener">Landscape</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">容器的SR-IOV技术</h1>
    
    <time>February 10, 2020</time>
    
    <div>
        <p>
        <h2 id="basics">Basics</h2>
<p>SR-IOV的全称是<em>Single Root I/O Virtualization</em>。</p>
<p>虚拟机中的网卡看起来是真实的硬件，实际则是宿主机虚拟化出来的设备，也就是运行的软件程序；这也意味着，虚拟设备是需要CPU去运行的，这样设备的性能会随着宿主机性能而改变，可能会产生额外的延时。</p>
<p>VT-D技术可以将物理机的PCIe设备直接分配给虚拟机，让虚拟机直接控制硬件，来避免上述问题。但是虚拟机会独占直通的PCIe设备，如果一台宿主机上有多个虚拟机，那就要求对应数量的物理网卡，这显然不现实。</p>
<p>为解决这样的问题，Intel提出来SR-IOV技术，该技术最初应用在网卡上。简单来讲，就是将一个物理网卡虚拟出多个轻量化的PCIe物理设备，再分配给虚拟机使用。</p>
<p>启用SR-IOV技术，可以大大减轻宿主机的CPU负荷，提高网络性能、降低网络延时，也避免了PCI-passthrough下各个物理网卡被各个容器独占的问题。</p>
<p><img src="https://uploadfiles.nowcoder.com/files/20200210/702387425_1581307499489_v2-02865d3c697f77ba4c8c251de49e6855_hd.jpg" alt="SR-IOV"></p>
<p>根据Oracle Solaris的文档描述，SR-IOV规范定义了新的标准，创建的新设备能将虚拟机直接连接到I/O设备，并获得于本机性能媲美的I/O性能。具体规范由PCI-SIG定义和维护。</p>
<h2 id="functions">Functions</h2>
<p>SR-IOV包含2种新功能类型：</p>
<ul>
<li>物理功能（Physical Function, PF）：用于支持SR-IOV功能的PCI功能。</li>
<li>虚拟功能（Virtual Function, VF）：与物理功能关联的一种功能。</li>
</ul>
<p>更具体来说，PF是包含完全的PCIe功能，可以像其他任何PCIe设备一样进行发现、管理和处理；PF拥有完全配置资源，可用于配置或控制PCIe设备。</p>
<p>VF是一种轻量级的PCIe功能，可以与物理功能及同一物理功能关联的其他VF共享一个或多个物理资源，且仅允许拥有用于其自身行为的配置资源。</p>
<p>每个SR-IOV设备都可以有一个PF，每个PF最多可以关联64,000个VF。PF可以通过专用寄存器创建VF。</p>
<p>一旦在PF中启用了SR-IOV，就可以通过PF的总线、设备和路由ID访问各个VF的PCI配置空间。每个VF具有一个映射了其寄存器集的PCI内存空间，VF设备驱动程序对寄存器集进行操作以启用其功能，并显示为实际存在的PCI设备。<br>
创建VF后，可以直接将其指定给IO guest域的各个应用程序。</p>
<p>此功能试的虚拟功能可以在没有CPU和VMM开销的情况下执行I/O。<br>
缺省状态下，SR-IOV功能处于禁用状态，PF充当传统PCIe设备。</p>
<p>SR-IOV技术也有其<strong>局限性</strong>，比如同一PF可关联的VF数量是<strong>有限</strong>的，而且是硬件绑定的，不支持容器迁移。</p>
<h2 id="docker-with-sr-iov">Docker with SR-IOV</h2>
<p>SR-IOV在虚拟化中应用广泛，理所当然地可以被用在容器上。</p>
<p>Intel官方就维护了一个SR-IOV的CNI插件，<a href="github.com/intel/sriov-cni">Intel/sriov-cni</a>。除此之外，其开发的clearcontainers项目下也有一个SR-IOV的network plugin，支持docker指定容器运行时为runc或clearcontainer时使用，见<a href="github.com/clearcontainers/sriov">clearcontainers/sriov</a>。</p>
<p>更多有关Docker Plugin的信息，请参考<a href="https://docs.docker.com/engine/extend/"><em>Docker Engine managed plugin system</em></a>。</p>
<p>下面我们采用clearcontainers提供的SR-IOV Docker Plugin进行安装。</p>
<h3 id="install-clear-containers-sriov-docker-plugin">Install Clear Containers SRIOV Docker Plugin</h3>
<p>环境要求：</p>
<ul>
<li>物理机（VM中可能找不到支持SR-IOV的PF）</li>
<li>Golang</li>
<li>Docker Engine</li>
</ul>
<p>克隆源码。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/clearcontainers/sriov.git
cd sriov
</code></pre></div><p>用Go Mod或者Dep等工具初始化go pkg依赖，配置docker/libnetwork项目到较新版本（旧版本会导致编译失败）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ go mod init
$ go mod vendor
$ cat go.mod

module github.com/clearcontainers/sriov

go 1.13

require <span style="color:#f92672">(</span>
        github.com/01org/ciao v0.0.0-20180108144400-194264adc583
        github.com/boltdb/bolt v1.3.1
        github.com/docker/libnetwork v0.7.2-rc.1
        github.com/golang/glog v0.0.0-20160126235308-23def4e6c14b
        github.com/gorilla/mux v1.7.3
        github.com/vishvananda/netlink v1.1.0
<span style="color:#f92672">)</span>
</code></pre></div><p>编译源码。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">go build
</code></pre></div><p>在host上安装SR-IOV插件，并在后台启动插件。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo cp sriov.json /etc/docker/plugins
sudo ./sriov &amp;
</code></pre></div><p>以Docker默认的runc容器运行时来测试插件功能。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># Create a virtual network on physical network b2b with vlanid 100</span>
sudo docker network create -d sriov --internal --opt pf_iface<span style="color:#f92672">=</span>eth0 --opt vlanid vfnet

<span style="color:#75715e"># Create container on the network vfnet</span>
docker run --net<span style="color:#f92672">=</span>vfnet -itd busybox top

<span style="color:#75715e"># Check that container is running</span>
docker ps

<span style="color:#75715e"># Cleanup</span>
docker stop <span style="color:#66d9ef">$(</span>docker ps -a -q<span style="color:#66d9ef">)</span>
docker rm <span style="color:#66d9ef">$(</span>docker ps -a -q<span style="color:#66d9ef">)</span>
sudo docker network rm vfnet
</code></pre></div><h2 id="kata-with-sr-iov">Kata with SR-IOV</h2>
<p><a href="github.com/kata-containers">Kata</a>是一个使用轻量虚拟机（VM）来替代传统的容器运行时（runc等），以达到容器间或Pod间的内核隔离的安全容器方案。其技术上的设计细节可以参考<a href="https://github.com/kata-containers/documentation/blob/master/design/architecture.md">Architecture - kata-containers/documentation</a>。</p>
<p>由于Kata默认采用QEMU作为hypervisor，而QEMU不支持veth，所以网络上的默认方案是采用TAP来为VM内外打通网络。前面我们了解到SR-IOV是不需要采用传统的veth的，在CPU、内核功能上支持SR-IOV的前提下，就可以采用SR-IOV来提升Kata容器的网络性能。</p>
<h3 id="setup-to-use-sr-iov-with-kata">Setup to Use SR-IOV with Kata</h3>
<p>遵循<a href="https://github.com/kata-containers/documentation/blob/master/use-cases/using-SRIOV-and-kata.md"><em>Setup to use SR-IOV with Kata Containers and Docker</em></a>一文，首先准备好clearcontainer的SR-IOV Docker Plugin。</p>
<h4 id="requirement">Requirement</h4>
<ul>
<li>Host支持Intel VT-d</li>
<li>NIC支持SR-IOV</li>
<li>Host的内核支持IOMMU和VFIO</li>
</ul>
<p>更新以下配置前，请最好确保你已经有当前host的足够新的<strong>备份</strong>。</p>
<p>检查你的NIC是否支持SR-IOV：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># get the pci class code of your NIC</span>
$ lspci | fgrep -i ethernet
01:00.0 Ethernet controller: Intel Corporation Ethernet Controller 10-Gigabit X540-AT2 <span style="color:#f92672">(</span>rev 03<span style="color:#f92672">)</span>
...

<span style="color:#75715e">#sudo required below to read the card capabilities</span>
$ sudo lspci -s 01:00.0 -v | grep SR-IOV
        Capabilities: <span style="color:#f92672">[</span>160<span style="color:#f92672">]</span> Single Root I/O Virtualization <span style="color:#f92672">(</span>SR-IOV<span style="color:#f92672">)</span>
</code></pre></div><p>检查host上的<a href="http://vfio.blogspot.com/2014/08/iommu-groups-inside-and-out.html">IOMMU groups</a>设置</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">find /sys/kernel/iommu_groups/ -type l
</code></pre></div><p>如果没有输出，就说明你需要按下面步骤更新内核的配置。</p>
<h4 id="update-host-kernel-configuration">Update Host Kernel Configuration</h4>
<p>开启intel-iommu，手动编辑<code>/etc/default/grub</code>或者下面的<code>sed</code>命令都应该可以；编辑好配置文件后，使用<code>update-grub</code>更新grub配置并重启：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># edit /etc/default/grub and add intel_iommu=on to cmdline:</span>
$ sudo sed -i -e <span style="color:#e6db74">&#39;s/^kernel_params = &#34;\(.*\)&#34;/GRUB_CMDLINE_LINUX=&#34;\1 intel_iommu=on&#34;/g&#39;</span> /etc/default/grub
$ sudo update-grub
$ sudo reboot -f
</code></pre></div><p>重启后，检查启动命令行（也就是上面更改的<code>CMDLINE_LINUX</code>）是否更新成功：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cat /proc/cmdline
BOOT_IMAGE<span style="color:#f92672">=</span>/boot/vmlinuz-4... root<span style="color:#f92672">=</span>UUID<span style="color:#f92672">=</span>4b... ... intel_iommu<span style="color:#f92672">=</span>on
</code></pre></div><p>使用<code>dmesg</code>命令查看系统启动信息，以检查Intel VT-d是否已初始化：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ dmesg | grep --color <span style="color:#e6db74">&#34;Virtualization&#34;</span>
<span style="color:#75715e"># output can be</span>
DMAR: Intel<span style="color:#f92672">(</span>R<span style="color:#f92672">)</span> Virtualization Technology <span style="color:#66d9ef">for</span> Directed I/O
<span style="color:#75715e"># or</span>
PCI-DMA: Intel<span style="color:#f92672">(</span>R<span style="color:#f92672">)</span> Virtualization Technology <span style="color:#66d9ef">for</span> Directed I/O
</code></pre></div><p>加入<code>vfio-pci</code>模块：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo modprobe vfio-pci
</code></pre></div><p>再次检查iommu group，确保你的NIC支持PCIE-ACS，即它的class id出现在以下find指令输出中，并且其对应的group id不包括其他设备：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ find /sys/kernel/iommu_groups/ -type l | grep <span style="color:#e6db74">&#34;01:00&#34;</span>
/sys/kernel/iommu_groups/35/devices/0000:01:00.1
/sys/kernel/iommu_groups/34/devices/0000:01:00.0
$ find /sys/kernel/iommu_groups/ -type l | grep <span style="color:#e6db74">&#34;35&#34;</span>
/sys/kernel/iommu_groups/35/devices/0000:01:00.1
</code></pre></div><h4 id="set-up-the-sr-iov-device">Set Up the SR-IOV Device</h4>
<p><strong>Remark</strong>: 前面小节的操作都是为了让host支持SR-IOV做的，只需要设置一次就行。下面的操作需要在每次系统启动后执行，以促进物理设备的VFs的设置。</p>
<p>加入<code>vfio-pci</code>设备驱动（上一节加过的可以不再做），该驱动将用于VF的保留：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo modprobe vfio-pci
</code></pre></div><p>查看你的NICs可以创建多少个VFs：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># use the pci class id of your NICs</span>
$ cat /sys/bus/pci/devices/0000<span style="color:#ae81ff">\:</span>01<span style="color:#ae81ff">\:</span>00.0/sriov_totalvfs
<span style="color:#ae81ff">63</span>
$ cat /sys/bus/pci/devices/0000<span style="color:#ae81ff">\:</span>01<span style="color:#ae81ff">\:</span>00.1/sriov_totalvfs
<span style="color:#ae81ff">63</span>
</code></pre></div><p>修改<code>sriov_numvfs</code>的值来创建VFs；注意每个NIC都会对应这样一个文件，每个<code>sriov_numvfs</code>的值默认为0，修改为2或者更多，恰好对应每个PF创建的VF，最多不超过上面的totalvfs值：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">vim /sys/bus/pci/devices/0000<span style="color:#ae81ff">\:</span>01<span style="color:#ae81ff">\:</span>00.0/sriov_numvfs
</code></pre></div><p>这里我们修改第一张NIC的numvfs为2，确认VF信息：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo lspci | grep Ethernet | grep Virtual
02:10.0 Ethernet controller: Intel Corporation X540 Ethernet Controller Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
02:10.1 Ethernet controller: Intel Corporation X540 Ethernet Controller Virtual Function <span style="color:#f92672">(</span>rev 01<span style="color:#f92672">)</span>
$ ls /sys/class/net/eth0/device/virtfn0/net
enp59s0f2
$ ls /sys/class/net/eth0/device/virtfn1/net
enp59s0f3
<span style="color:#75715e"># the path for other NICs&#39; VF can be &#34;/sys/class/net/eth2/device/virtfn1/net&#34;</span>
</code></pre></div><p>目前的VF是没有MAC地址的，为它们设置MAC地址来保证host和VM中的地址一致性，下面以第一个VF为例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ip link show dev eth0
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1550</span> qdisc mq state UP mode DEFAULT group default qlen <span style="color:#ae81ff">1000</span>
    link/ether b8:59:xx:xx:xx:xx brd ff:ff:ff:ff:ff:ff
    vf <span style="color:#ae81ff">0</span> MAC 00:00:00:00:00:00, spoof checking off, link-state auto, trust off, query_rss off
    vf <span style="color:#ae81ff">1</span> MAC 00:00:00:00:00:00, spoof checking off, link-state auto, trust off, query_rss off
$ ip link show dev enp59s0f2
13: enp59s0f2: &lt;BROADCAST,MULTICAST&gt; mtu <span style="color:#ae81ff">1500</span> qdisc noop state DOWN mode DEFAULT group default qlen <span style="color:#ae81ff">1000</span>
    link/ether 4a:b3:xx:xx:xx:xx brd ff:ff:ff:ff:ff:ff
$ ip link set eth0 vf <span style="color:#ae81ff">0</span> mac 4a:b3:xx:xx:xx:xx
<span style="color:#75715e"># also set MAC for other VFs</span>
$ ip link show dev eth0
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1550</span> qdisc mq state UP mode DEFAULT group default qlen <span style="color:#ae81ff">1000</span>
    link/ether b8:59:xx:xx:xx:xx brd ff:ff:ff:ff:ff:ff
    vf <span style="color:#ae81ff">0</span> MAC 4a:b3:xx:xx:xx:xx, spoof checking off, link-state auto, trust off, query_rss off
    vf <span style="color:#ae81ff">1</span> MAC ee:20:xx:xx:xx:xx, spoof checking off, link-state auto, trust off, query_rss off
</code></pre></div><h4 id="launch-a-kata-container-using-sr-iov">Launch a Kata Container using SR-IOV</h4>
<p>首先，按照<a href="#install-clear-containers-sriov-docker-plugin"><em>Install Clear Containers SRIOV Docker Plugin</em></a>中的步骤，启用sriov的Docker Plugin。</p>
<p>然后，创建docker network：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker network create -d sriov --internal --opt pf_iface<span style="color:#f92672">=</span>eth0 --opt vlanid<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span> --subnet<span style="color:#f92672">=</span>192.168.0.0/24 vfnet
E0212 15:07:55.427057 <span style="color:#ae81ff">1187089</span> plugin.go:298<span style="color:#f92672">]</span> Numvfs and Totalvfs are not same on the PF - Initialize numvfs to totalvfs
ee2e5a594f9e4d3796eda972f3b46e52342aea04cbae8e5eac9b2dd6ff37b067
</code></pre></div><p>使用新建的network来创建kata容器：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker run --net<span style="color:#f92672">=</span>vfnet --runtime<span style="color:#f92672">=</span>kata-runtime --cap-add SYS_ADMIN --ip<span style="color:#f92672">=</span>192.168.0.10 -it busybox ls /
bin   dev   etc   home  proc  root  sys   tmp   usr   var
</code></pre></div><p>清除动作与使用runc的方式类似。</p>
<h2 id="参考资料">参考资料</h2>
<ol>
<li><em>SR-IOV是什么？性能能好到什么程度？</em>. 钱乎. 知乎专栏</li>
<li>SR-IOV简介 - 编写驱动程序. Oracle</li>
<li><em>Setup to use SR-IOV with Kata Containers and Docker</em>. kata-containers. GitHub</li>
</ol>

        </p>
    </div>
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "Frame" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="/tags/cloud">#cloud</a>
        
            <a class="tag" href="/tags/container">#container</a>
        
            <a class="tag" href="/tags/virtualization">#virtualization</a>
        
      
    </div>


        

<link rel="stylesheet" type="text/css" href="/css/katex.min.css">
<script type="text/javascript" src="/js/katex.min.js"></script>
<script type="text/javascript" src="/js/auto-render.min.js"onload="renderMathInElement(document.body);"></script>

        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        
    <a class="social-icon" href="mailto:saintube@foxmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://www.github.com/saintube" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://www.cncf.io/" target="_blank" rel="noopener">CNCF</a></p>
		<p><a href="https://landscape.cncf.io/" target="_blank" rel="noopener">Landscape</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>