<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>Frame&#39;s Blog</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="/css/main.min.2545a1910010e26a9905276045afab868f812580a1e7482423da6c0c8c214d18.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="/">Frame&#39;s Blog</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="/about/">关于</a>
  
    <a class="color-link nav-link" href="/tags/">标签</a>
  
    <a class="color-link nav-link" href="/archives/">归档</a>
  
</div>
<footer class="footer">
	<div class="social-icons">
        
    <a class="social-icon" href="mailto:saintube@foxmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://www.github.com/saintube" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://www.cncf.io/" target="_blank" rel="noopener">CNCF</a></p>
	<p><a href="https://landscape.cncf.io/" target="_blank" rel="noopener">Landscape</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">Kata Containers 入门笔记（二）</h1>
    
    <time>March 7, 2020</time>
    
    <div>
        <p>
        <p>本节简单介绍Kata Containers项目的基本架构。</p>
<h2 id="overview">Overview</h2>
<p>Kata Containers是MicroVM类型的安全容器方案，它支持QEMU和Firecracker作为hypervisor，运行VM来替代传统基于namespace、cgroup的容器。</p>
<p><img src="https://uploadfiles.nowcoder.com/images/20200307/702387425_1583546434042_E7AC90920F9176692F2FE43FBC99D351" alt="docker-kata" title="docker-kata"></p>
<p>Kata Containers包含runtime、proxy、shim、agent等多个组件，其中kata-runtime可以与containerd-shim配合使用，也可以直接和dockerd配合。1.5.0版本后，社区提供了将containerd-shim、kata-runtime、kata-proxy、kata-shim三者整合的版本，containerd-shim-kata-v2，简化了Kata在K8s上使用的控制链路。</p>
<p>用户可以在K8s、Docker上切换使用runc或者kata作为容器运行时方案，Kata能为每个Pod或Container创建QEMU/KVM的VM，以更安全的MicroVM替代sharing kernel的传统容器。</p>
<h2 id="components">Components</h2>
<p><img src="https://uploadfiles.nowcoder.com/images/20200307/702387425_1583553039790_DC44DB9399C3083B5D84AC7659BC6F28" alt="k8s-kata" title="图片标题"></p>
<p><strong><a href="https://github.com/kata-containers/runtime">kata-runtime</a></strong>:</p>
<p>在设计上，kata-runtime兼容<a href="https://github.com/opencontainers/runtime-spec">OCI (Open Container Initiative) runtime spec</a>，支持类似runC的create、delete、exec等CLI命令，同时；它也支持<a href="https://kubernetes.io/blog/2016/12/container-runtime-interface-cri-in-kubernetes/">K8s CRI (Container Runtime Interface)</a>，支持<a href="https://github.com/containernetworking/cni">CNI (Container Networking Interface)</a>标准。<br>
你可以直接使用kata-runtime CLI作为Kata Containers的entrypoint，也支持用K8s和Docker切换使用runc或Kata，创建不同类型的container runtime。</p>
<p><strong><a href="https://github.com/kata-containers/agent">kata-agent</a></strong>:</p>
<p>Kata-agent运行在kata创建的VM内部，它负责在VM内以runc的方式去创建容器，也就是说，Kata方案下还是包含了传统容器的，host上（即运行kata-runtime的OS环境）原本的传统容器会以VM per Pod或VM per Container的形式被替代，但它们还是会运行在Kata的创建的VM内部。</p>
<p>Kata-agent会在VM内运行一个gRPC server，然后借助QEMU、以VIRTIO serial或VSOCK interface的形式在host上暴露一个socket file。Kata-runtime会通过gRPC来与kata-agent通信（不过一般二者之间还有kata-proxy作为中介），以管理VM内的容器。<br>
同时，gRPC server也携带了容器和container engine之间的I/O streams，比如stdin、stdout、stderr。处理这类资源就是kata-proxy和kata-shim的事情了。</p>
<p><strong><a href="https://github.com/kata-containers/proxy">kata-proxy</a></strong>:</p>
<p>Kata VM内的容器与container engine（比如Docker Engine）之间的I/O streams是借助QEMU以VIRTIO serial或者VSOCK interface的形式暴露到host的。使用VIRTIO serial方案时，kata会为每个VM运行一个kata-proxy，以实现容器执行命令和streams的multiplexing和demultiplexing。<br>
一般情况下，kata-runtime会通过kata-proxy来与VM内的kata-agent通信，以控制VM内容器进程的管理。</p>
<p><strong><a href="https://github.com/kata-containers/shim">kata-shim</a></strong>:</p>
<p>Kata-shim的出现主要是考虑了VM内有多个容器的情况。每个容器进程的移除由外层的一个reaper负责，在Docker或者containerd中就是containerd-shim，在cri-o中则是conmon。而Kata方案中，多个容器可能运行在一个VM内，host上原有的reaper无法监控、控制和回收这些VM内的容器，所以就设计了位于kata-proxy和reaper之间的kata-shim，kata-runtime会为每个container创建一个对应的kata-shim，每个Pod sandbox也会有一个kata-shim。<br>
Kata-shim会向VM内的容器进程转发signals和stdin streams，也会通过reaper将容器的stdout、stderr streams返回给CRI shim或者Docker。这样docker exec之类的OCI指令就可以作用于VM内的某个容器。</p>
<p><strong><a href="https://github.com/kata-containers/runtime/tree/master/containerd-shim-v2">containerd-shim-kata-v2</a></strong>:</p>
<p>Containerd-shim-kata-v2可以替换kata-runtime，作为Kata的另一个entrypoint。它集成了原本的kata-runtime、kata-shim、kata-proxy以及reaper的功能。<br>
在runtime+shim+proxy+agent的方案中，每个Pod需要2N+1个shim，即每个容器对应一对containerd-shim+kata-shim，而每个Pod Sandbox也会有一个kata-shim。而containerd-shim-kata-v2实现了<a href="https://github.com/containerd/containerd/tree/master/runtime/v2">Containerd Runtime V2 (Shim API)</a>，K8s只需要为每个Pod、包括其内部的多个容器创建一个shimv2就够了。除此之外，无论是否kata-agent的gRPC server是否使用VSOCK暴露到host上，都不再需要单独的kata-proxy。</p>
<h2 id="networking">Networking</h2>
<p>Kata受限于hypervisor的功能，没有直接采用docker默认的bridge网络方案，而是采用的MACVTAP方案。<br>
不过Kata本身是支持CNM和CNI来做组网的，网络方面相比容器，虽有额外开销但兼容性不差。</p>
<p>我们知道，docker默认采用的容器网络方案是基于netns+bridge+veth pairs的，即在host上创建一个network namespace，在docker0 bridge上连接veth pairs的一端，再去netns中连上另一端，打通容器和host之间的网络。<br>
这种方案集中于namespace技术，而许多hypervisor比如QEMU不能处理veth interfaces。所以Kata为VM创建了TAP interfaces来打通VM和host之间的网络。传统的container engine比如Docker，会为容器创建netns和veth pair，然后Kata-runtime会将veth pair的一端连上TAP，即MACVTAP方案。</p>
<img src="https://uploadfiles.nowcoder.com/images/20200307/702387425_1583552200790_AB6D9333F5C60EBA0C5EBF89C834DEB3" width="700" height="300" alt="macvtap" align=center>
<h2 id="references">References</h2>
<ol>
<li><a href="https://github.com/kata-containers/runtime">kata-containers/runtime</a></li>
<li><a href="https://github.com/kata-containers/documentation/blob/master/design/architecture.md">Architecture - Kata Containers</a></li>
</ol>

        </p>
    </div>
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "Frame" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="/tags/cloud">#cloud</a>
        
            <a class="tag" href="/tags/container">#container</a>
        
            <a class="tag" href="/tags/virtualization">#virtualization</a>
        
            <a class="tag" href="/tags/kubernetes">#kubernetes</a>
        
      
    </div>


        

<link rel="stylesheet" type="text/css" href="/css/katex.min.css">
<script type="text/javascript" src="/js/katex.min.js"></script>
<script type="text/javascript" src="/js/auto-render.min.js"onload="renderMathInElement(document.body);"></script>

        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        
    <a class="social-icon" href="mailto:saintube@foxmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://www.github.com/saintube" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://www.cncf.io/" target="_blank" rel="noopener">CNCF</a></p>
		<p><a href="https://landscape.cncf.io/" target="_blank" rel="noopener">Landscape</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>